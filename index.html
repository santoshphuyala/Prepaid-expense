<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prepaid Expense Calculator — Enhanced</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    body { min-height: 100vh; padding: 20px 10px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; }
    .calculator-container { background: rgba(255,255,255,.98); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.07); padding: 20px; backdrop-filter: blur(3px); }
    .table thead th { background: #4e54c8; color: #fff; position: sticky; top: 0; z-index: 1; cursor: pointer; font-size: 0.9rem; padding: 8px; }
    .btn-custom { transition: all .2s ease; border-radius: 24px; padding: 10px 20px; min-width: 48px; min-height: 48px; font-size: 0.9rem; touch-action: manipulation; }
    .btn-custom:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,.13); }
    .btn-custom:disabled { cursor: not-allowed; opacity: 0.65; }
    .summary-box { background: #f8f9fa; padding: 15px; border-radius: 16px; margin-top: 20px; border-left: 5px solid #4e54c8; }
    h1 { color: #4e54c8; text-shadow: 2px 2px 4px rgba(0,0,0,.07); font-size: 1.5rem; }
    h6 { font-size: 1rem; }
    .form-label { color: #4e54c8; font-weight: 600; font-size: 0.9rem; }
    #restoreInput, #importInput { display: none; }
    .invalid-feedback { display: block; font-size: 0.8rem; }
    .form-error { border-color: #dc3545 !important; }
    .badge-muted { background: #e9ecef; color: #495057; }
    .form-text { font-size: 0.75rem; }
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table td, .table th { padding: 8px; font-size: 0.85rem; }
    .sort-icon::after { content: '↕'; margin-left: 5px; }
    .sort-asc::after { content: '↑'; }
    .sort-desc::after { content: '↓'; }
    @media (max-width: 768px) {
      .row.g-3 { flex-direction: column; }
      .col-md-3, .col-md-2, .col-md-1 { width: 100%; margin-bottom: 10px; }
      .btn-custom { width: 100%; margin-bottom: 10px; }
      .summary-box .d-flex { flex-direction: column; }
      .table-responsive { max-height: 400px; }
      h1 { font-size: 1.2rem; }
      .form-control, .form-select { font-size: 0.9rem; }
    }
    @media (max-width: 576px) {
      .summary-box .d-flex { display: none; }
      .summary-box.active .d-flex { display: flex; flex-direction: column; }
      .hamburger { display: block; font-size: 1.2rem; cursor: pointer; }
    }
    @media print {
      body { background: none; }
      .calculator-container { box-shadow: none; padding: 0; }
      .btn, .toast-container, .form-label, .form-control, .form-select, .hamburger, .form-text { display: none; }
      h1, h6 { color: #000 !important; }
    }
  </style>
</head>
<body>
  <div class="container calculator-container">
    <h1 class="text-center mb-4">Prepaid Expense Calculator</h1>
    <div id="errorBox" class="alert alert-danger d-none" role="alert"></div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">Task completed successfully!</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>
    <form id="expenseForm" class="mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="expenseName" class="form-label">Expense Name</label>
          <input type="text" class="form-control" id="expenseName" required aria-describedby="expenseNameHelp" data-bs-toggle="tooltip" title="Name of the prepaid expense" />
          <div id="expenseNameHelp" class="form-text">Enter the name of the expense.</div>
        </div>
        <div class="col-md-2">
          <label for="amount" class="form-label">Amount</label>
          <input type="number" class="form-control" id="amount" min="0.01" step="0.01" required aria-describedby="amountHelp" data-bs-toggle="tooltip" title="Total amount of the expense" />
          <div id="amountHelp" class="form-text">Enter the expense amount.</div>
        </div>
        <div class="col-md-2">
          <label for="startDate" class="form-label">Start Date</label>
          <input type="date" class="form-control" id="startDate" required aria-describedby="startDateHelp" data-bs-toggle="tooltip" title="Start date of the coverage period" />
          <div id="startDateHelp" class="form-text">Select start date.</div>
        </div>
        <div class="col-md-2">
          <label for="periodValue" class="form-label">Covered Period</label>
          <input type="number" class="form-control" id="periodValue" min="1" required aria-describedby="periodValueHelp" data-bs-toggle="tooltip" title="Duration of the coverage" />
          <div id="periodValueHelp" class="form-text">Enter period duration.</div>
        </div>
        <div class="col-md-1">
          <label for="periodUnit" class="form-label">Unit</label>
          <select class="form-select" id="periodUnit" required aria-describedby="periodUnitHelp" data-bs-toggle="tooltip" title="Unit for the covered period">
            <option value="days">Days</option>
            <option value="months">Months</option>
            <option value="years" selected>Years</option>
          </select>
          <div id="periodUnitHelp" class="form-text">Select period unit.</div>
        </div>
        <div class="col-md-2">
          <label for="fiscalYearEnd" class="form-label">Fiscal Year End</label>
          <input type="date" class="form-control" id="fiscalYearEnd" required aria-describedby="fiscalYearEndHelp" data-bs-toggle="tooltip" title="End date of the fiscal year" />
          <div id="fiscalYearEndHelp" class="form-text">Select fiscal year end.</div>
        </div>
        <div class="col-12 mt-2 text-center">
          <button type="button" id="addExpense" class="btn btn-primary btn-custom me-2" data-bs-toggle="tooltip" title="Add or update the expense"><i class="fa fa-plus"></i> Add Expense</button>
          <button type="button" class="btn btn-secondary btn-custom" id="clearForm" data-bs-toggle="tooltip" title="Clear the form fields"><i class="fa fa-eraser"></i> Clear</button>
        </div>
      </div>
    </form>
    <div class="mb-3">
      <input type="text" id="filterInput" class="form-control" placeholder="Filter by name" aria-describedby="filterHelp" data-bs-toggle="tooltip" title="Filter expenses by name" />
      <div id="filterHelp" class="form-text">Search expenses by name.</div>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle" id="expenseTable">
        <thead>
          <tr>
            <th data-column="name" data-bs-toggle="tooltip" title="Sort by expense name" aria-sort="none">Name <span class="sort-icon"></span></th>
            <th data-column="amount" data-bs-toggle="tooltip" title="Sort by amount" aria-sort="none">Amount <span class="sort-icon"></span></th>
            <th data-column="startDate" data-bs-toggle="tooltip" title="Sort by start date" aria-sort="none">Start <span class="sort-icon"></span></th>
            <th data-column="endDate" data-bs-toggle="tooltip" title="Sort by end date" aria-sort="none">End <span class="sort-icon"></span></th>
            <th data-column="fiscalYearEnd" data-bs-toggle="tooltip" title="Sort by fiscal year end" aria-sort="none">FY End <span class="sort-icon"></span></th>
            <th data-column="current" data-bs-toggle="tooltip" title="Sort by current portion" aria-sort="none">Current <span class="sort-icon"></span></th>
            <th data-column="prepaid" data-bs-toggle="tooltip" title="Sort by prepaid portion" aria-sort="none">Prepaid <span class="sort-icon"></span></th>
            <th data-column="currentDays" data-bs-toggle="tooltip" title="Sort by current days" class="text-nowrap" aria-sort="none">Current Days <span class="sort-icon"></span></th>
            <th data-column="prepaidDays" data-bs-toggle="tooltip" title="Sort by prepaid days" class="text-nowrap" aria-sort="none">Prepaid Days <span class="sort-icon"></span></th>
            <th data-bs-toggle="tooltip" title="Edit or delete">Actions</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody"></tbody>
        <tfoot id="expenseTableFoot"></tfoot>
      </table>
    </div>
    <div class="summary-box" id="summaryBox">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Summary</h5>
        <span class="hamburger d-none" onclick="document.getElementById('summaryBox').classList.toggle('active')">☰</span>
      </div>
      <p>Total Current Expenses: <span id="totalCurrent">0.00</span></p>
      <p>Total Prepaid Expenses: <span id="totalPrepaid">0.00</span></p>
      <div id="journalEntriesSummary"></div>
      <div class="d-flex flex-wrap gap-2 mt-3">
        <div class="dropdown">
          <button class="btn btn-primary dropdown-toggle btn-custom" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Export data">
            <i class="fa fa-file-export"></i> Export
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="exportExcel"><i class="fa fa-file-excel"></i> Excel</a></li>
            <li><a class="dropdown-item" href="#" id="exportCsv"><i class="fa fa-file-csv"></i> CSV</a></li>
            <li><a class="dropdown-item" href="#" id="exportPdf"><i class="fa fa-file-pdf"></i> PDF</a></li>
          </ul>
        </div>
        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle btn-custom" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Import data from Excel or CSV">
            <i class="fa fa-file-import"></i> Import
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" data-type="excel">Excel</a></li>
            <li><a class="dropdown-item" href="#" data-type="csv">CSV</a></li>
          </ul>
        </div>
        <input type="file" id="importInput" accept=".xlsx,.xls,.csv" />
        <button class="btn btn-warning btn-custom" id="btnBackup" data-bs-toggle="tooltip" title="Backup data to JSON"><i class="fa fa-download"></i> Backup</button>
        <button class="btn btn-primary btn-custom" id="btnRestore" data-bs-toggle="tooltip" title="Restore data from JSON"><i class="fa fa-upload"></i> Restore</button>
        <input type="file" id="restoreInput" accept=".json" />
        <button class="btn btn-warning btn-custom" id="btnUndo" data-bs-toggle="tooltip" title="Undo last action"><i class="fa fa-undo"></i> Undo</button>
        <button class="btn btn-warning btn-custom" id="btnRedo" data-bs-toggle="tooltip" title="Redo last action"><i class="fa fa-redo"></i> Redo</button>
        <button class="btn btn-danger btn-custom" id="btnDeleteAll" data-bs-toggle="tooltip" title="Delete all expenses after confirmation"><i class="fa fa-trash"></i> Delete All</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script>
    // --- Utilities ---
    const iso = (d) => new Date(d).toISOString().split('T')[0];
    const numberFmt = () => new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const showError = (msg) => {
      const errorBox = document.getElementById('errorBox');
      errorBox.textContent = msg;
      errorBox.classList.remove('d-none');
      setTimeout(() => errorBox.classList.add('d-none'), 3000);
    };
    const showSuccess = (msg = 'Task completed successfully!') => {
      const toast = new bootstrap.Toast(document.getElementById('successToast'));
      document.querySelector('#successToast .toast-body').textContent = msg;
      toast.show();
    };
    const getCurrentDate = () => iso(new Date());
    const sanitize = (str) => str.replace(/[<>&'"]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;' }[c]));
    const debounce = (func, wait) => {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    };

    const el = (tag, props = {}, children = []) => {
      const node = document.createElement(tag);
      Object.entries(props).forEach(([k, v]) => {
        if (k === 'class') node.className = v;
        else if (k.startsWith('on') && typeof v === 'function') node.addEventListener(k.substring(2).toLowerCase(), v);
        else if (k === 'text') node.textContent = v;
        else node.setAttribute(k, v);
      });
      children.forEach(c => node.appendChild(c));
      return node;
    };

    function addPeriod(start, value, unit) {
      const d = new Date(start);
      const val = parseInt(value);
      if (unit === 'days') d.setDate(d.getDate() + val);
      else if (unit === 'months') d.setMonth(d.getMonth() + val);
      else if (unit === 'years') d.setFullYear(d.getFullYear() + val);
      return d;
    }
    function diffDays(a, b) {
      return Math.max(0, Math.ceil((b - a) / (1000 * 60 * 60 * 24)));
    }

    class ExpenseManager {
      constructor() {
        this.expenses = [];
        this.stateHistory = [];
        this.currentStateIndex = -1;
        this.sortColumn = null;
        this.sortDirection = 'asc';
        this.loadData();
        this.saveState();
        this.renderTable = debounce(this.renderTable.bind(this), 100);
        this.renderTable();
        this.setupEventListeners();
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
      }
      setupEventListeners() {
        document.getElementById('addExpense').addEventListener('click', () => {
          document.getElementById('expenseForm').requestSubmit();
        });
        document.getElementById('expenseForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
        document.getElementById('clearForm').addEventListener('click', () => {
          document.getElementById('expenseForm').reset();
          ['expenseName', 'amount', 'startDate', 'periodValue', 'fiscalYearEnd'].forEach(id => {
            const field = document.getElementById(id);
            field.classList.remove('form-error');
            const feedback = field.nextElementSibling?.classList.contains('invalid-feedback') ? field.nextElementSibling : null;
            if (feedback) feedback.remove();
          });
        });
        document.getElementById('filterInput').addEventListener('input', (e) => this.renderTable(e.target.value.toLowerCase()));
        document.querySelectorAll('#expenseTable th:not(:last-child)').forEach((th) => {
          th.addEventListener('click', () => this.sortTable(th.dataset.column));
        });

        // Export button dropdowns
        document.getElementById('exportExcel').addEventListener('click', (e) => { e.preventDefault(); this.exportToExcel(); });
        document.getElementById('exportCsv').addEventListener('click', (e) => { e.preventDefault(); this.exportToCSV(); });
        document.getElementById('exportPdf').addEventListener('click', (e) => { e.preventDefault(); this.exportToPDF(); });

        document.querySelectorAll('.dropdown-menu a[data-type]').forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('importInput').setAttribute('accept', item.dataset.type === 'excel' ? '.xlsx,.xls' : '.csv');
            document.getElementById('importInput').dataset.type = item.dataset.type;
            document.getElementById('importInput').click();
          });
        });
        document.getElementById('importInput').addEventListener('change', (e) => this.handleImport(e));
        document.getElementById('btnBackup').addEventListener('click', () => this.backupData());
        document.getElementById('btnRestore').addEventListener('click', () => document.getElementById('restoreInput').click());
        document.getElementById('restoreInput').addEventListener('change', (e) => this.restoreData(e));
        document.getElementById('btnUndo').addEventListener('click', () => this.undo());
        document.getElementById('btnRedo').addEventListener('click', () => this.redo());
        document.getElementById('btnDeleteAll').addEventListener('click', () => this.deleteAll());
      }
      saveState() {
        if (this.currentStateIndex < this.stateHistory.length - 1) {
          this.stateHistory = this.stateHistory.slice(0, this.currentStateIndex + 1);
        }
        this.stateHistory.push(JSON.stringify({ expenses: this.expenses }));
        if (this.stateHistory.length > 10) this.stateHistory.shift();
        this.currentStateIndex = this.stateHistory.length - 1;
      }
      undo() {
        if (this.currentStateIndex <= 0) return showError('Nothing to undo');
        if (!confirm('Undo last action?')) return;
        this.currentStateIndex--;
        const data = JSON.parse(this.stateHistory[this.currentStateIndex]);
        this.expenses = data.expenses || [];
        this.saveData();
        this.renderTable();
        showSuccess('Action undone successfully!');
      }
      redo() {
        if (this.currentStateIndex >= this.stateHistory.length - 1) return showError('Nothing to redo');
        if (!confirm('Redo last action?')) return;
        this.currentStateIndex++;
        const data = JSON.parse(this.stateHistory[this.currentStateIndex]);
        this.expenses = data.expenses || [];
        this.saveData();
        this.renderTable();
        showSuccess('Action redone successfully!');
      }
      handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const fields = [
          { id: 'expenseName', value: document.getElementById('expenseName').value.trim(), validate: v => v, error: 'Expense name is required' },
          { id: 'amount', value: parseFloat(document.getElementById('amount').value), validate: v => !isNaN(v) && v > 0, error: 'Amount must be greater than 0' },
          { id: 'startDate', value: new Date(document.getElementById('startDate').value), validate: v => !isNaN(v), error: 'Invalid start date' },
          { id: 'periodValue', value: parseInt(document.getElementById('periodValue').value), validate: v => !isNaN(v) && v >= 1, error: 'Period must be at least 1' },
          { id: 'fiscalYearEnd', value: new Date(document.getElementById('fiscalYearEnd').value), validate: v => !isNaN(v), error: 'Invalid fiscal year end' }
        ];
        fields.forEach(field => {
          const el = document.getElementById(field.id);
          el.classList.remove('form-error');
          const feedback = el.nextElementSibling?.classList.contains('invalid-feedback') ? el.nextElementSibling : null;
          if (feedback) feedback.remove();
        });
        let valid = true;
        fields.forEach(field => {
          if (!field.validate(field.value)) {
            valid = false;
            const el = document.getElementById(field.id);
            el.classList.add('form-error');
            el.insertAdjacentElement('afterend', el('div', { class: 'invalid-feedback', text: field.error }));
          }
        });
        if (!valid) return;
        const name = sanitize(fields[0].value);
        const amount = fields[1].value;
        const startDate = fields[2].value;
        const periodValue = fields[3].value;
        const periodUnit = document.getElementById('periodUnit').value;
        const fiscalYearEnd = fields[4].value;
        const endDate = addPeriod(startDate, periodValue, periodUnit);
        const totalDays = diffDays(startDate, endDate);
        const currentDays = diffDays(startDate, Math.min(fiscalYearEnd, endDate));
        const prepaidDays = diffDays(Math.min(fiscalYearEnd, endDate), endDate);
        const current = totalDays ? (currentDays / totalDays) * amount : 0;
        const prepaid = totalDays ? (prepaidDays / totalDays) * amount : 0;
        this.saveState();
        const expense = {
          id: form.dataset.editId ? parseInt(form.dataset.editId) : Date.now(),
          name,
          amount,
          startDate,
          endDate,
          fiscalYearEnd,
          current,
          prepaid,
          currentDays,
          prepaidDays,
          periodValue,
          periodUnit
        };
        if (form.dataset.editId) {
          if (!confirm('Are you sure you want to save changes to this expense?')) return;
          const index = this.expenses.findIndex(e => e.id === parseInt(form.dataset.editId));
          this.expenses[index] = expense;
          delete form.dataset.editId;
          showSuccess('Expense updated successfully!');
        } else {
          this.expenses.push(expense);
          showSuccess('Expense added successfully!');
        }
        this.saveData();
        this.renderTable();
        form.reset();
      }
      enterEditMode(id) {
        if (!confirm('Are you sure you want to edit this expense?')) return;
        const expense = this.expenses.find(e => e.id === id);
        if (expense) {
          document.getElementById('expenseName').value = expense.name;
          document.getElementById('amount').value = expense.amount;
          document.getElementById('startDate').value = iso(expense.startDate);
          document.getElementById('periodValue').value = expense.periodValue;
          document.getElementById('periodUnit').value = expense.periodUnit;
          document.getElementById('fiscalYearEnd').value = iso(expense.fiscalYearEnd);
          document.getElementById('expenseForm').dataset.editId = id;
        }
      }
      deleteExpense(id) {
        if (!confirm('Are you sure you want to delete this expense?')) return;
        this.saveState();
        this.expenses = this.expenses.filter(e => e.id !== id);
        this.saveData();
        this.renderTable();
        showSuccess('Expense deleted successfully!');
      }
      deleteAll() {
        if (!confirm('Are you sure you want to delete all expenses?')) return;
        this.saveState();
        this.expenses = [];
        this.saveData();
        this.renderTable();
        showSuccess('All expenses deleted successfully!');
      }
      sortTable(column) {
        if (this.sortColumn === column) {
          this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          this.sortColumn = column;
          this.sortDirection = 'asc';
        }
        const fields = {
          name: 'name',
          amount: 'amount',
          startDate: 'startDate',
          endDate: 'endDate',
          fiscalYearEnd: 'fiscalYearEnd',
          current: 'current',
          prepaid: 'prepaid',
          currentDays: 'currentDays',
          prepaidDays: 'prepaidDays'
        };
        this.expenses.sort((a, b) => {
          const valA = a[fields[column]], valB = b[fields[column]];
          const factor = this.sortDirection === 'asc' ? 1 : -1;
          return typeof valA === 'string' ? factor * valA.localeCompare(valB) : factor * (valA - valB);
        });
        this.renderTable(document.getElementById('filterInput').value.toLowerCase());
      }
      renderTable(filter = '') {
        const tbody = document.getElementById('expenseTableBody');
        const tfoot = document.getElementById('expenseTableFoot');
        const fmt = numberFmt();
        const filteredExpenses = filter ? this.expenses.filter(e => e.name.toLowerCase().includes(filter)) : this.expenses;
        const currentIds = new Set(filteredExpenses.map(e => e.id));
        const existingRows = Array.from(tbody.querySelectorAll('tr'));
        existingRows.forEach(row => {
          const id = parseInt(row.dataset.id);
          if (!currentIds.has(id)) row.remove();
        });

        let totalAmount = 0, totalCurrent = 0, totalPrepaid = 0;
        filteredExpenses.forEach(expense => {
          totalAmount += expense.amount;
          totalCurrent += expense.current;
          totalPrepaid += expense.prepaid;
          let row = tbody.querySelector(`tr[data-id="${expense.id}"]`);
          if (!row) {
            row = el('tr', { 'data-id': expense.id, role: 'row' });
            tbody.appendChild(row);
          }
          row.innerHTML = `
            <td role="cell">${sanitize(expense.name)}</td>
            <td role="cell">${fmt.format(expense.amount)}</td>
            <td role="cell">${iso(expense.startDate)}</td>
            <td role="cell">${iso(expense.endDate)}</td>
            <td role="cell">${iso(expense.fiscalYearEnd)}</td>
            <td role="cell">${fmt.format(expense.current)}</td>
            <td role="cell">${fmt.format(expense.prepaid)}</td>
            <td role="cell">${expense.currentDays || 0}</td>
            <td role="cell">${expense.prepaidDays || 0}</td>
            <td role="cell">
              <button class="btn btn-sm btn-warning edit-btn" data-bs-toggle="tooltip" title="Edit this expense"><i class="fa fa-pen"></i></button>
              <button class="btn btn-sm btn-danger delete-btn ms-1" data-bs-toggle="tooltip" title="Delete this expense"><i class="fa fa-trash"></i></button>
            </td>`;
          row.querySelector('.edit-btn').onclick = () => this.enterEditMode(expense.id);
          row.querySelector('.delete-btn').onclick = () => this.deleteExpense(expense.id);
        });

        // Grand Total Row
        tfoot.innerHTML = `
          <tr style="font-weight:bold; background:#e9ecef;">
            <td>Grand Total</td>
            <td>${fmt.format(totalAmount)}</td>
            <td></td>
            <td></td>
            <td></td>
            <td>${fmt.format(totalCurrent)}</td>
            <td>${fmt.format(totalPrepaid)}</td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
        `;

        document.getElementById('totalCurrent').textContent = fmt.format(totalCurrent);
        document.getElementById('totalPrepaid').textContent = fmt.format(totalPrepaid);

        // Journal Entries in Summary
        this.renderJournalEntriesSummary(filteredExpenses, fmt);

        document.querySelectorAll('#expenseTable th').forEach(th => {
          th.setAttribute('aria-sort', 'none');
          th.querySelector('.sort-icon')?.classList.remove('sort-asc', 'sort-desc');
          if (th.dataset.column === this.sortColumn) {
            th.setAttribute('aria-sort', this.sortDirection);
            th.querySelector('.sort-icon')?.classList.add(`sort-${this.sortDirection}`);
          }
        });
      }
      renderJournalEntriesSummary(filteredExpenses, fmt) {
        const summaryDiv = document.getElementById('journalEntriesSummary');
        let html = `<h6>Journal Entries</h6><ul style="padding-left:1.2em">`;
        filteredExpenses.forEach(exp => {
          html += `<li><strong>${sanitize(exp.name)}:</strong>
            <ul style="padding-left:1.2em">
              <li>
                On payment: <br>
                &nbsp;&nbsp;Dr. ${sanitize(exp.name)} <strong>${fmt.format(exp.amount)}</strong><br>
                &nbsp;&nbsp;Cr. Bank <strong>${fmt.format(exp.amount)}</strong> (${iso(exp.startDate)})
              </li>
              <li>
                At year end to record prepaid: <br>
                &nbsp;&nbsp;Dr. Prepaid ${sanitize(exp.name)} <strong>${fmt.format(exp.prepaid)}</strong><br>
                &nbsp;&nbsp;Cr. ${sanitize(exp.name)} <strong>${fmt.format(exp.prepaid)}</strong> (${iso(exp.fiscalYearEnd)})
              </li>
            </ul>
          </li>`;
        });
        html += `</ul>`;
        summaryDiv.innerHTML = html;
      }

      // ----------------- Enhanced Export Functions -----------------

      exportToExcel() {
        const btn = document.getElementById('exportExcel');
        if (btn) btn.disabled = true;
        if (btn) btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Excel';
        setTimeout(() => {
          const fmt = numberFmt();
          const ws_data = [];

          // Add summary section at the top
          ws_data.push(['Summary']);
          ws_data.push(['Total Current Expenses', fmt.format(this.expenses.reduce((a, e) => a + e.current, 0))]);
          ws_data.push(['Total Prepaid Expenses', fmt.format(this.expenses.reduce((a, e) => a + e.prepaid, 0))]);
          ws_data.push([]);
          ws_data.push(['Expenses']);

          // Table headers
          const headers = [
            'Name', 'Amount', 'Start', 'End', 'Fiscal Year End', 'Current', 'Prepaid',
            'Current Days', 'Prepaid Days', 'Period Value', 'Period Unit'
          ];
          ws_data.push(headers);

          // Table data
          this.expenses.forEach(e => {
            ws_data.push([
              e.name,
              e.amount,
              iso(e.startDate),
              iso(e.endDate),
              iso(e.fiscalYearEnd),
              e.current,
              e.prepaid,
              e.currentDays,
              e.prepaidDays,
              e.periodValue,
              e.periodUnit
            ]);
          });

          // Grand total row
          let totalAmount = 0, totalCurrent = 0, totalPrepaid = 0;
          this.expenses.forEach(e => {
            totalAmount += e.amount;
            totalCurrent += e.current;
            totalPrepaid += e.prepaid;
          });
          ws_data.push([
            'Grand Total', totalAmount, '', '', '', totalCurrent, totalPrepaid, '', '', '', ''
          ]);

          // Create worksheet and set formatting
          const ws = XLSX.utils.aoa_to_sheet(ws_data);

          // Style headers
          const range = XLSX.utils.decode_range(ws['!ref']);
          for (let C = 0; C < headers.length; ++C) {
            const cell = ws[XLSX.utils.encode_cell({ r: 5, c: C })];
            if (cell) {
              cell.s = { font: { bold: true }, fill: { fgColor: { rgb: "DDEBF7" } }, border: { bottom: { style: "thin", color: { rgb: "000000" } } } };
            }
          }
          // Set column widths
          ws['!cols'] = [
            { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 16 }, { wch: 14 }, { wch: 14 },
            { wch: 11 }, { wch: 12 }, { wch: 11 }, { wch: 11 }
          ];

          // --- Journal Entries Sheet ---
          const summaryRows = [];
          summaryRows.push(['Journal Entries']);
          summaryRows.push([]);
          summaryRows.push(['Expense Name', 'Initial Entry', 'Year-End Entry']);
          this.expenses.forEach(e => {
            summaryRows.push([
              e.name,
              `Dr. ${e.name} ${fmt.format(e.amount)} / Cr. Bank ${fmt.format(e.amount)} (${iso(e.startDate)})`,
              `Dr. Prepaid ${e.name} ${fmt.format(e.prepaid)} / Cr. ${e.name} ${fmt.format(e.prepaid)} (${iso(e.fiscalYearEnd)})`
            ]);
          });
          summaryRows.push([
            'Grand Total',
            `Dr. ${fmt.format(totalAmount)} / Cr. Bank ${fmt.format(totalAmount)}`,
            `Dr. Prepaid (all) ${fmt.format(totalPrepaid)} / Cr. (all) ${fmt.format(totalPrepaid)}`
          ]);
          const summaryWs = XLSX.utils.aoa_to_sheet(summaryRows);

          summaryWs['!cols'] = [
            { wch: 24 }, { wch: 46 }, { wch: 46 }
          ];
          // Bold header
          ['A3', 'B3', 'C3'].forEach(addr => {
            if (summaryWs[addr]) summaryWs[addr].s = { font: { bold: true }, fill: { fgColor: { rgb: "F9D34B" } } };
          });

          // Create workbook and export
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Expenses+Summary');
          XLSX.utils.book_append_sheet(wb, summaryWs, 'Journal Entries');

          XLSX.writeFile(wb, `expenses_${getCurrentDate()}.xlsx`);
          if (btn) btn.disabled = false;
          if (btn) btn.innerHTML = '<i class="fa fa-file-excel"></i> Excel';
          showSuccess('Excel exported successfully!');
        }, 0);
      }

      exportToPDF() {
        const btn = document.getElementById('exportPdf');
        if (btn) btn.disabled = true;
        if (btn) btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> PDF';
        setTimeout(() => {
          const fmt = numberFmt();
          const doc = new window.jspdf.jsPDF({ orientation: 'landscape', format: 'a4' }); // A4 landscape

          // Table
          const columns = [
            { header: 'Name', dataKey: 'name' },
            { header: 'Amount', dataKey: 'amount' },
            { header: 'Start', dataKey: 'startDate' },
            { header: 'End', dataKey: 'endDate' },
            { header: 'FY End', dataKey: 'fiscalYearEnd' },
            { header: 'Current', dataKey: 'current' },
            { header: 'Prepaid', dataKey: 'prepaid' },
            { header: 'Cur Days', dataKey: 'currentDays' },
            { header: 'Pre Days', dataKey: 'prepaidDays' },
            { header: 'Period', dataKey: 'periodValue' },
            { header: 'Unit', dataKey: 'periodUnit' }
          ];
          const data = this.expenses.map(e => ({
            name: e.name,
            amount: fmt.format(e.amount),
            startDate: iso(e.startDate),
            endDate: iso(e.endDate),
            fiscalYearEnd: iso(e.fiscalYearEnd),
            current: fmt.format(e.current),
            prepaid: fmt.format(e.prepaid),
            currentDays: e.currentDays,
            prepaidDays: e.prepaidDays,
            periodValue: e.periodValue,
            periodUnit: e.periodUnit
          }));

          // Grand total
          let totalAmount = 0, totalCurrent = 0, totalPrepaid = 0;
          this.expenses.forEach(e => {
            totalAmount += e.amount;
            totalCurrent += e.current;
            totalPrepaid += e.prepaid;
          });
          data.push({
            name: 'Grand Total',
            amount: fmt.format(totalAmount),
            startDate: '',
            endDate: '',
            fiscalYearEnd: '',
            current: fmt.format(totalCurrent),
            prepaid: fmt.format(totalPrepaid),
            currentDays: '',
            prepaidDays: '',
            periodValue: '',
            periodUnit: ''
          });

          // Summary section
          doc.setFontSize(13);
          doc.text('Expense List', 14, 14);
          doc.setFontSize(10);
          doc.text(`Total Current Expenses: ${fmt.format(totalCurrent)}`, 14, 22);
          doc.text(`Total Prepaid Expenses: ${fmt.format(totalPrepaid)}`, 90, 22);

          // Data Table
          doc.autoTable({
            columns,
            body: data,
            startY: 28,
            styles: {
              fontSize: 8,
              cellPadding: 2
            },
            headStyles: {
              fillColor: [78, 84, 200],
              textColor: 255,
              fontStyle: 'bold'
            },
            alternateRowStyles: { fillColor: [245, 245, 250] },
            theme: 'striped',
            margin: { left: 14, right: 14 }
          });

          // Journal Entries - move to new page if needed
          let y = doc.lastAutoTable.finalY + 8;
          if (y > 160) {
            doc.addPage();
            y = 18;
          }
          doc.setFontSize(12);
          doc.text('Journal Entries', 14, y);
          y += 6;
          doc.setFontSize(9);
          this.expenses.forEach(e => {
            doc.setFont(undefined, 'bold');
            doc.text(`${e.name}:`, 16, y);
            y += 5;
            doc.setFont(undefined, 'normal');
            doc.text(
              `On payment: Dr. ${e.name} ${fmt.format(e.amount)} / Cr. Bank ${fmt.format(e.amount)} (${iso(e.startDate)})`,
              20, y
            );
            y += 5;
            doc.text(
              `At year end: Dr. Prepaid ${e.name} ${fmt.format(e.prepaid)} / Cr. ${e.name} ${fmt.format(e.prepaid)} (${iso(e.fiscalYearEnd)})`,
              20, y
            );
            y += 8;
            if (y > 185) { doc.addPage(); y = 18; }
          });
          // Grand Total
          doc.setFont(undefined, 'bold');
          doc.text(
            `Grand Total: Dr. ${fmt.format(totalAmount)} / Cr. Bank ${fmt.format(totalAmount)} | Dr. Prepaid (all) ${fmt.format(totalPrepaid)} / Cr. (all) ${fmt.format(totalPrepaid)}`,
            16, y
          );

          doc.save(`expenses_${getCurrentDate()}.pdf`);
          if (btn) btn.disabled = false;
          if (btn) btn.innerHTML = '<i class="fa fa-file-pdf"></i> PDF';
          showSuccess('PDF exported successfully!');
        }, 0);
      }

      // ----------------------------------------------------------------

      exportToCSV() {
        const btn = document.getElementById('exportCsv');
        if (btn) btn.disabled = true;
        if (btn) btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> CSV';
        setTimeout(() => {
          const data = this.expenses.map(e => ({
            ID: e.id,
            Name: e.name,
            Amount: e.amount,
            Start: iso(e.startDate),
            End: iso(e.endDate),
            'Fiscal Year End': iso(e.fiscalYearEnd),
            Current: e.current,
            Prepaid: e.prepaid,
            'Current Days': e.currentDays,
            'Prepaid Days': e.prepaidDays,
            'Period Value': e.periodValue,
            'Period Unit': e.periodUnit
          }));
          // Add Grand Total
          let totalAmount = 0, totalCurrent = 0, totalPrepaid = 0;
          this.expenses.forEach(e => {
            totalAmount += e.amount;
            totalCurrent += e.current;
            totalPrepaid += e.prepaid;
          });
          data.push({
            ID: '',
            Name: 'Grand Total',
            Amount: totalAmount,
            Start: '',
            End: '',
            'Fiscal Year End': '',
            Current: totalCurrent,
            Prepaid: totalPrepaid,
            'Current Days': '',
            'Prepaid Days': '',
            'Period Value': '',
            'Period Unit': ''
          });
          const ws = XLSX.utils.json_to_sheet(data);

          // Summary sheet as additional CSV file
          const fmt = numberFmt();
          const summaryRows = this.expenses.map(e => ({
            Name: e.name,
            'Initial Entry': `Dr. ${e.name} ${fmt.format(e.amount)}  /  Cr. Bank ${fmt.format(e.amount)} (${iso(e.startDate)})`,
            'Year-End Entry': `Dr. Prepaid ${e.name} ${fmt.format(e.prepaid)}  /  Cr. ${e.name} ${fmt.format(e.prepaid)} (${iso(e.fiscalYearEnd)})`
          }));
          summaryRows.push({
            Name: 'Grand Total',
            'Initial Entry': `Dr. ${fmt.format(totalAmount)}  /  Cr. Bank ${fmt.format(totalAmount)}`,
            'Year-End Entry': `Dr. Prepaid (all) ${fmt.format(totalPrepaid)}  /  Cr. (all) ${fmt.format(totalPrepaid)}`
          });
          const ws2 = XLSX.utils.json_to_sheet(summaryRows);

          const csv = XLSX.utils.sheet_to_csv(ws);
          const csv2 = XLSX.utils.sheet_to_csv(ws2);
          const blob = new Blob([csv + '\n\nSummary\n\n' + csv2], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = el('a', { href: url, download: `expenses_${getCurrentDate()}.csv` });
          a.click();
          URL.revokeObjectURL(url);
          if (btn) btn.disabled = false;
          if (btn) btn.innerHTML = '<i class="fa fa-file-csv"></i> CSV';
          showSuccess('CSV exported successfully!');
        }, 0);
      }
      handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        const type = e.target.dataset.type;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const wb = XLSX.read(event.target.result, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            let importedExpenses = XLSX.utils.sheet_to_json(ws);
            const requiredFields = ['ID', 'Name', 'Amount', 'Start', 'End', 'Fiscal Year End', 'Period Value', 'Period Unit'];
            const headers = Object.keys(importedExpenses[0] || {});
            const missing = requiredFields.filter(f => !headers.includes(f));
            if (missing.length) return showError(`Missing required columns: ${missing.join(', ')}`);
            importedExpenses = importedExpenses.filter(exp => {
              const valid =
                exp.ID && !isNaN(exp.ID) &&
                exp.Name && typeof exp.Name === 'string' &&
                !isNaN(exp.Amount) && exp.Amount > 0 &&
                !isNaN(new Date(exp.Start)) &&
                !isNaN(new Date(exp.End)) &&
                !isNaN(new Date(exp['Fiscal Year End'])) &&
                !isNaN(exp['Period Value']) && exp['Period Value'] > 0 &&
                ['days', 'months', 'years'].includes(exp['Period Unit']);
              return valid;
            }).map(exp => ({
              id: parseInt(exp.ID),
              name: sanitize(exp.Name),
              amount: parseFloat(exp.Amount),
              startDate: new Date(exp.Start),
              endDate: new Date(exp.End),
              fiscalYearEnd: new Date(exp['Fiscal Year End']),
              current: parseFloat(exp.Current || 0),
              prepaid: parseFloat(exp.Prepaid || 0),
              currentDays: parseInt(exp['Current Days'] || 0),
              prepaidDays: parseInt(exp['Prepaid Days'] || 0),
              periodValue: parseInt(exp['Period Value']),
              periodUnit: exp['Period Unit']
            }));
            this.saveState();
            importedExpenses.forEach(imp => {
              if (!this.expenses.find(ex => ex.id === imp.id)) {
                this.expenses.push(imp);
              }
            });
            this.saveData();
            this.renderTable();
            showSuccess('Data imported successfully! Duplicates avoided.');
          } catch (err) {
            showError('Invalid file or format');
          }
          e.target.value = '';
        };
        reader.readAsBinaryString(file);
      }
      backupData() {
        const data = JSON.stringify({ expenses: this.expenses }, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = el('a', { href: url, download: `backup_${getCurrentDate()}.json` });
        a.click();
        URL.revokeObjectURL(url);
        showSuccess('Backup created successfully!');
      }
      restoreData(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (!Array.isArray(data.expenses)) throw new Error('Invalid backup format');
            this.saveState();
            this.expenses = data.expenses.map(exp => ({
              ...exp,
              startDate: new Date(exp.startDate),
              endDate: new Date(exp.endDate),
              fiscalYearEnd: new Date(exp.fiscalYearEnd)
            }));
            this.saveData();
            this.renderTable();
            showSuccess('Restore successful!');
          } catch (err) {
            showError('Invalid backup file');
          }
          e.target.value = '';
        };
        reader.readAsText(file);
      }
      saveData() {
        localStorage.setItem('expenses', JSON.stringify(this.expenses));
      }
      loadData() {
        const data = localStorage.getItem('expenses');
        if (data) {
          try {
            this.expenses = JSON.parse(data).map(exp => ({
              ...exp,
              startDate: new Date(exp.startDate),
              endDate: new Date(exp.endDate),
              fiscalYearEnd: new Date(exp.fiscalYearEnd)
            }));
          } catch {}
        }
      }
    }
    new ExpenseManager();
  </script>
</body>
</html>
