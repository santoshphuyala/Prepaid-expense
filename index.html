<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prepaid Expense Calculator â€” Enhanced</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .calculator-container { background: rgba(255,255,255,.95); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.2); padding: 32px; backdrop-filter: blur(5px); }
    .table thead th { background:#4e54c8; color:#fff; position: sticky; top: 0; z-index: 1; }
    .btn-custom { transition: all .2s ease; border-radius: 24px; padding: 8px 16px; }
    .btn-custom:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,.2); }
    .entry-box, .summary-box { background:#f8f9fa; padding: 20px; border-radius: 16px; margin-top: 24px; border-left:5px solid #4e54c8; }
    h1 { color:#fff; text-shadow: 2px 2px 4px rgba(0,0,0,.2); }
    .form-label { color:#4e54c8; font-weight:600; }
    #restoreInput, #importInput { display:none; }
    .invalid-feedback { display:block; }
    .form-error { border-color: #dc3545 !important; }
    .badge-muted { background: #e9ecef; color: #495057; }
    /* Enhanced responsiveness */
    @media (max-width: 768px) {
      .row.g-3 { flex-direction: column; }
      .col-md-3, .col-md-2, .col-md-1, .col-md-4 { width: 100%; }
      .table-responsive { overflow-x: auto; }
    }
    /* Graphical styles for exports */
    .export-table th { background-color: #4e54c8; color: white; }
    .export-table td, .export-table th { border: 1px solid #ddd; padding: 8px; }
    .export-table tr:nth-child(even) { background-color: #f2f2f2; }
    .journal-table { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container calculator-container">
    <h1 class="text-center mb-4">Prepaid Expense Calculator</h1>

    <!-- Currency -->
    <div class="row g-3 align-items-end mb-3">
      <div class="col-md-4">
        <label for="currencySelect" class="form-label">Currency</label>
        <select class="form-select" id="currencySelect" data-bs-toggle="tooltip" title="Select the currency for formatting amounts"></select>
        <div class="form-text">Uses locale-safe formatting via Intl.NumberFormat.</div>
      </div>
      <div class="col-md-3">
        <label for="customCurrencyCode" class="form-label">Add Currency (ISO code)</label>
        <input id="customCurrencyCode" class="form-control" placeholder="e.g., USD, NPR, EUR" data-bs-toggle="tooltip" title="Enter a valid ISO currency code to add" />
      </div>
      <div class="col-md-2">
        <button class="btn btn-success btn-custom w-100" id="addCurrency" data-bs-toggle="tooltip" title="Add the custom currency">Add</button>
      </div>
    </div>

    <!-- Errors -->
    <div id="errorBox" class="alert alert-danger d-none" role="alert"></div>

    <!-- Success Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">Task completed successfully!</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form id="expenseForm" class="mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="expenseName" class="form-label">Expense Name</label>
          <input type="text" class="form-control" id="expenseName" required data-bs-toggle="tooltip" title="Name of the prepaid expense" />
        </div>
        <div class="col-md-2">
          <label for="amount" class="form-label">Amount</label>
          <input type="number" class="form-control" id="amount" min="0.01" step="0.01" required data-bs-toggle="tooltip" title="Total amount of the expense" />
        </div>
        <div class="col-md-2">
          <label for="startDate" class="form-label">Start Date</label>
          <input type="date" class="form-control" id="startDate" required data-bs-toggle="tooltip" title="Start date of the coverage period" />
        </div>
        <div class="col-md-2">
          <label for="periodValue" class="form-label">Covered Period</label>
          <input type="number" class="form-control" id="periodValue" min="1" required data-bs-toggle="tooltip" title="Duration of the coverage" />
        </div>
        <div class="col-md-1">
          <label for="periodUnit" class="form-label">Unit</label>
          <select class="form-select" id="periodUnit" required data-bs-toggle="tooltip" title="Unit for the covered period">
            <option value="days">Days</option>
            <option value="months">Months</option>
            <option value="years">Years</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="fiscalYearEnd" class="form-label">Fiscal Year End</label>
          <input type="date" class="form-control" id="fiscalYearEnd" required data-bs-toggle="tooltip" title="End date of the fiscal year" />
        </div>
        <div class="col-12 mt-2 text-center">
          <button type="submit" class="btn btn-primary btn-custom me-2" data-bs-toggle="tooltip" title="Add or update the expense">Add Expense</button>
          <button type="button" class="btn btn-secondary btn-custom" id="clearForm" data-bs-toggle="tooltip" title="Clear the form fields">Clear</button>
        </div>
      </div>
    </form>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle" id="expenseTable">
        <thead>
          <tr>
            <th data-bs-toggle="tooltip" title="Name of the expense">Expense Name</th>
            <th data-bs-toggle="tooltip" title="Total amount">Amount</th>
            <th data-bs-toggle="tooltip" title="Start date">Start</th>
            <th data-bs-toggle="tooltip" title="End date">End</th>
            <th data-bs-toggle="tooltip" title="Fiscal year end">FY End</th>
            <th data-bs-toggle="tooltip" title="Current portion of expense">Current</th>
            <th data-bs-toggle="tooltip" title="Prepaid portion of expense">Prepaid</th>
            <th class="text-nowrap" data-bs-toggle="tooltip" title="Days in current period">Current Days</th>
            <th class="text-nowrap" data-bs-toggle="tooltip" title="Days in prepaid period">Prepaid Days</th>
            <th data-bs-toggle="tooltip" title="Edit or delete">Actions</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody"></tbody>
      </table>
    </div>

    <!-- Summary & Exports/Imports -->
    <div class="summary-box">
      <h5>Summary</h5>
      <p>Total Current Expenses: <span id="totalCurrent">0.00</span></p>
      <p>Total Prepaid Expenses: <span id="totalPrepaid">0.00</span></p>
      <div class="d-flex flex-wrap gap-2">
        <!-- Export Dropdown -->
        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle btn-custom" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-toggle="tooltip" title="Export data in various formats">
            Export
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="exportPdf">PDF</a></li>
            <li><a class="dropdown-item" href="#" id="exportExcel">Excel</a></li>
            <li><a class="dropdown-item" href="#" id="exportCsv">CSV</a></li>
            <li><a class="dropdown-item" href="#" id="exportJson">JSON</a></li>
          </ul>
        </div>
        <!-- Import Section -->
        <select id="importType" class="form-select btn-custom me-2" style="width: auto;" data-bs-toggle="tooltip" title="Select import format">
          <option value="excel">Excel</option>
          <option value="csv">CSV</option>
          <option value="json">JSON</option>
        </select>
        <button class="btn btn-primary btn-custom" id="importButton" data-bs-toggle="tooltip" title="Import data from file">Import</button>
        <input type="file" id="importInput" accept=".xlsx,.xls,.csv,.json" />
        <button class="btn btn-danger btn-custom" id="btnDeleteAll" data-bs-toggle="tooltip" title="Delete all expenses after confirmation">Delete All</button>
      </div>
    </div>

    <!-- Journal Entries -->
    <div class="entry-box" id="journalEntries">
      <h5>Journal Entries</h5>
      <h6>Initial Entries</h6>
      <div class="table-responsive">
        <table class="table table-striped journal-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Account</th>
              <th>Debit</th>
              <th>Credit</th>
              <th>Narration</th>
            </tr>
          </thead>
          <tbody id="initialEntriesBody"></tbody>
        </table>
      </div>
      <h6>Adjusting Entries</h6>
      <div class="table-responsive">
        <table class="table table-striped journal-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Account</th>
              <th>Debit</th>
              <th>Credit</th>
              <th>Narration</th>
            </tr>
          </thead>
          <tbody id="adjustingEntriesBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // --- Utilities ---
    const iso = (d) => new Date(d).toISOString().split('T')[0]; // YYYY-MM-DD
    const numberFmt = (currency) => new Intl.NumberFormat(undefined, { style: 'currency', currency, maximumFractionDigits: 2 });
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const showError = (msg) => {
      const errorBox = document.getElementById('errorBox');
      errorBox.textContent = msg;
      errorBox.classList.remove('d-none');
      setTimeout(() => errorBox.classList.add('d-none'), 3000);
    };
    const showSuccess = (msg = 'Task completed successfully!') => {
      const toast = new bootstrap.Toast(document.getElementById('successToast'));
      document.querySelector('#successToast .toast-body').textContent = msg;
      toast.show();
    };
    const getCurrentDate = () => iso(new Date()); // Use current date for filenames

    const el = (tag, props = {}, children = []) => {
      const node = document.createElement(tag);
      Object.entries(props).forEach(([k, v]) => {
        if (k === 'class') node.className = v;
        else if (k.startsWith('on') && typeof v === 'function') node.addEventListener(k.substring(2).toLowerCase(), v);
        else if (k === 'text') node.textContent = v;
        else node.setAttribute(k, v);
      });
      children.forEach(c => node.appendChild(c));
      return node;
    };

    function addPeriod(start, value, unit) {
      const d = new Date(start);
      const val = parseInt(value);
      if (unit === 'days') d.setDate(d.getDate() + val);
      else if (unit === 'months') d.setMonth(d.getMonth() + val);
      else if (unit === 'years') d.setFullYear(d.getFullYear() + val);
      return d;
    }

    function diffDays(a, b) {
      return Math.max(0, Math.ceil((b - a) / (1000 * 60 * 60 * 24)));
    }

    class ExpenseManager {
      constructor() {
        this.expenses = [];
        this.currencies = ['USD', 'NPR', 'EUR', 'INR', 'GBP'];
        this.selectedCurrency = 'USD';
        this.loadData();
        this.renderCurrencyOptions();
        this.renderTable();
        this.renderJournalEntries();
        this.setupEventListeners();
        // Enable tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
      }

      setupEventListeners() {
        // Form submission
        document.getElementById('expenseForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
        // Clear form
        document.getElementById('clearForm').addEventListener('click', () => document.getElementById('expenseForm').reset());
        // Add currency
        document.getElementById('addCurrency').addEventListener('click', () => this.addCurrency());
        // Currency change
        document.getElementById('currencySelect').addEventListener('change', (e) => {
          this.selectedCurrency = e.target.value;
          this.saveData();
          this.renderTable();
          this.renderJournalEntries();
        });
        // Export options
        document.getElementById('exportPdf').addEventListener('click', (e) => { e.preventDefault(); this.exportToPDF(); });
        document.getElementById('exportExcel').addEventListener('click', (e) => { e.preventDefault(); this.exportToExcel(); });
        document.getElementById('exportCsv').addEventListener('click', (e) => { e.preventDefault(); this.exportToCSV(); });
        document.getElementById('exportJson').addEventListener('click', (e) => { e.preventDefault(); this.exportToJSON(); });
        // Import
        document.getElementById('importButton').addEventListener('click', () => document.getElementById('importInput').click());
        document.getElementById('importInput').addEventListener('change', (e) => this.handleImport(e));
        // Delete all
        document.getElementById('btnDeleteAll').addEventListener('click', () => this.deleteAll());
      }

      handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const name = document.getElementById('expenseName').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const startDate = new Date(document.getElementById('startDate').value);
        const periodValue = parseInt(document.getElementById('periodValue').value);
        const periodUnit = document.getElementById('periodUnit').value;
        const fiscalYearEnd = new Date(document.getElementById('fiscalYearEnd').value);

        // Validation
        if (!name) return showError('Expense name is required');
        if (isNaN(amount) || amount <= 0) return showError('Amount must be greater than 0');
        if (isNaN(startDate)) return showError('Invalid start date');
        if (isNaN(periodValue) || periodValue < 1) return showError('Period must be at least 1');
        if (isNaN(fiscalYearEnd)) return showError('Invalid fiscal year end');

        const endDate = addPeriod(startDate, periodValue, periodUnit);
        const totalDays = diffDays(startDate, endDate);
        const currentDays = diffDays(startDate, Math.min(fiscalYearEnd, endDate));
        const prepaidDays = diffDays(Math.min(fiscalYearEnd, endDate), endDate);
        const current = totalDays ? (currentDays / totalDays) * amount : 0;
        const prepaid = totalDays ? (prepaidDays / totalDays) * amount : 0;

        const expense = {
          id: form.dataset.editId ? parseInt(form.dataset.editId) : Date.now(),
          name,
          amount,
          startDate,
          endDate,
          fiscalYearEnd,
          current,
          prepaid,
          currentDays,
          prepaidDays,
          periodValue,
          periodUnit
        };

        if (form.dataset.editId) {
          if (!confirm('Are you sure you want to save changes to this expense?')) return;
          const index = this.expenses.findIndex(e => e.id === parseInt(form.dataset.editId));
          this.expenses[index] = expense;
          delete form.dataset.editId;
          showSuccess('Expense updated successfully!');
        } else {
          this.expenses.push(expense);
          showSuccess('Expense added successfully!');
        }

        this.saveData();
        this.renderTable();
        this.renderJournalEntries();
        form.reset();
      }

      addCurrency() {
        const code = document.getElementById('customCurrencyCode').value.trim().toUpperCase();
        try {
          new Intl.NumberFormat(undefined, { style: 'currency', currency: code });
          if (!this.currencies.includes(code)) {
            this.currencies.push(code);
            this.renderCurrencyOptions();
            this.saveData();
            document.getElementById('customCurrencyCode').value = '';
            showSuccess('Currency added successfully!');
          } else {
            showError('Currency already exists');
          }
        } catch (e) {
          showError('Invalid currency code');
        }
      }

      enterEditMode(id) {
        if (!confirm('Are you sure you want to edit this expense?')) return;
        const expense = this.expenses.find(e => e.id === id);
        if (expense) {
          document.getElementById('expenseName').value = expense.name;
          document.getElementById('amount').value = expense.amount;
          document.getElementById('startDate').value = iso(expense.startDate);
          document.getElementById('periodValue').value = expense.periodValue;
          document.getElementById('periodUnit').value = expense.periodUnit;
          document.getElementById('fiscalYearEnd').value = iso(expense.fiscalYearEnd);
          document.getElementById('expenseForm').dataset.editId = id;
        }
      }

      deleteExpense(id) {
        if (!confirm('Are you sure you want to delete this expense?')) return;
        this.expenses = this.expenses.filter(e => e.id !== id);
        this.saveData();
        this.renderTable();
        this.renderJournalEntries();
        showSuccess('Expense deleted successfully!');
      }

      deleteAll() {
        if (!confirm('Are you sure you want to delete all expenses?')) return;
        this.expenses = [];
        this.saveData();
        this.renderTable();
        this.renderJournalEntries();
        showSuccess('All expenses deleted successfully!');
      }

      renderTable() {
        const tbody = document.getElementById('expenseTableBody');
        tbody.innerHTML = '';
        const fmt = numberFmt(this.selectedCurrency);
        let totalCurrent = 0, totalPrepaid = 0;
        this.expenses.forEach(expense => {
          totalCurrent += expense.current;
          totalPrepaid += expense.prepaid;
          const tr = el('tr', { 'data-id': expense.id }, [
            el('td', { text: expense.name }),
            el('td', { text: fmt.format(expense.amount) }),
            el('td', { text: iso(expense.startDate) }),
            el('td', { text: iso(expense.endDate) }),
            el('td', { text: iso(expense.fiscalYearEnd) }),
            el('td', { text: fmt.format(expense.current) }),
            el('td', { text: fmt.format(expense.prepaid) }),
            el('td', { text: expense.currentDays || 0 }),
            el('td', { text: expense.prepaidDays || 0 }),
            el('td', {}, [
              el('button', { class: 'btn btn-sm btn-warning edit-btn', text: 'Edit', onclick: () => this.enterEditMode(expense.id), 'data-bs-toggle': 'tooltip', title: 'Edit this expense' }),
              el('button', { class: 'btn btn-sm btn-danger delete-btn ms-1', text: 'Delete', onclick: () => this.deleteExpense(expense.id), 'data-bs-toggle': 'tooltip', title: 'Delete this expense' })
            ])
          ]);
          tbody.appendChild(tr);
        });
        document.getElementById('totalCurrent').textContent = fmt.format(totalCurrent);
        document.getElementById('totalPrepaid').textContent = fmt.format(totalPrepaid);
      }

      renderJournalEntries() {
        const fmt = numberFmt(this.selectedCurrency);
        const initialBody = document.getElementById('initialEntriesBody');
        const adjustingBody = document.getElementById('adjustingEntriesBody');
        initialBody.innerHTML = '';
        adjustingBody.innerHTML = '';
        this.expenses.forEach(expense => {
          // Initial Entry
          const initialNarration = `To record prepaid expense for ${expense.name}`;
          initialBody.appendChild(el('tr', {}, [
            el('td', { text: iso(expense.startDate) }),
            el('td', { text: 'Prepaid Expense' }),
            el('td', { text: fmt.format(expense.amount) }),
            el('td', { text: '' }),
            el('td', { text: initialNarration })
          ]));
          initialBody.appendChild(el('tr', {}, [
            el('td', { text: '' }),
            el('td', { text: 'Cash' }),
            el('td', { text: '' }),
            el('td', { text: fmt.format(expense.amount) }),
            el('td', { text: '' })
          ]));

          // Adjusting Entry
          const adjustingNarration = `To adjust prepaid expense for ${expense.name} to current expense`;
          adjustingBody.appendChild(el('tr', {}, [
            el('td', { text: iso(expense.fiscalYearEnd) }),
            el('td', { text: 'Expense' }),
            el('td', { text: fmt.format(expense.current) }),
            el('td', { text: '' }),
            el('td', { text: adjustingNarration })
          ]));
          adjustingBody.appendChild(el('tr', {}, [
            el('td', { text: '' }),
            el('td', { text: 'Prepaid Expense' }),
            el('td', { text: '' }),
            el('td', { text: fmt.format(expense.current) }),
            el('td', { text: '' })
          ]));
        });
      }

      exportToPDF() {
        const element = document.querySelector('.calculator-container');
        html2pdf().from(element).set({
          filename: `expenses_${getCurrentDate()}.pdf`,
          html2canvas: { scale: 2 },
          jsPDF: { orientation: 'landscape' }
        }).save();
        showSuccess('PDF exported successfully!');
      }

      exportToExcel() {
        const data = this.expenses.map(e => ({
          ID: e.id,
          Name: e.name,
          Amount: e.amount,
          Start: iso(e.startDate),
          End: iso(e.endDate),
          'Fiscal Year End': iso(e.fiscalYearEnd),
          Current: e.current,
          Prepaid: e.prepaid,
          'Current Days': e.currentDays,
          'Prepaid Days': e.prepaidDays,
          'Period Value': e.periodValue,
          'Period Unit': e.periodUnit
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        // Add graphical formatting
        ws['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cell = XLSX.utils.encode_cell({ r: 0, c: C });
          if (!ws[cell]) continue;
          ws[cell].s = { fill: { fgColor: { rgb: "4e54c8" } }, font: { color: { rgb: "FFFFFF" } }, alignment: { horizontal: 'center' } };
        }
        for (let R = range.s.r + 1; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell = XLSX.utils.encode_cell({ r: R, c: C });
            if (!ws[cell]) continue;
            ws[cell].s = { border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } } };
            if (R % 2 === 0) ws[cell].s.fill = { fgColor: { rgb: "F2F2F2" } };
          }
        }
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
        XLSX.writeFile(wb, `expenses_${getCurrentDate()}.xlsx`);
        showSuccess('Excel exported successfully!');
      }

      exportToCSV() {
        const data = this.expenses.map(e => ({
          ID: e.id,
          Name: e.name,
          Amount: e.amount,
          Start: iso(e.startDate),
          End: iso(e.endDate),
          'Fiscal Year End': iso(e.fiscalYearEnd),
          Current: e.current,
          Prepaid: e.prepaid,
          'Current Days': e.currentDays,
          'Prepaid Days': e.prepaidDays,
          'Period Value': e.periodValue,
          'Period Unit': e.periodUnit
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const csv = XLSX.utils.sheet_to_csv(ws);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = el('a', { href: url, download: `expenses_${getCurrentDate()}.csv` });
        a.click();
        URL.revokeObjectURL(url);
        showSuccess('CSV exported successfully!');
      }

      exportToJSON() {
        const data = JSON.stringify({ expenses: this.expenses }, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = el('a', { href: url, download: `expenses_${getCurrentDate()}.json` });
        a.click();
        URL.revokeObjectURL(url);
        showSuccess('JSON exported successfully!');
      }

      handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        const type = document.getElementById('importType').value;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            let importedExpenses;
            if (type === 'json') {
              const data = JSON.parse(event.target.result);
              importedExpenses = data.expenses || [];
            } else {
              const wb = XLSX.read(event.target.result, { type: 'binary' });
              const ws = wb.Sheets[wb.SheetNames[0]];
              importedExpenses = XLSX.utils.sheet_to_json(ws);
              // Convert date strings back to Date objects
              importedExpenses = importedExpenses.map(exp => ({
                ...exp,
                startDate: new Date(exp.Start),
                endDate: new Date(exp.End),
                fiscalYearEnd: new Date(exp['Fiscal Year End'])
              }));
            }
            // Merge: add only if id not exists
            importedExpenses.forEach(imp => {
              if (!this.expenses.find(ex => ex.id === imp.id)) {
                this.expenses.push(imp);
              }
            });
            this.saveData();
            this.renderTable();
            this.renderJournalEntries();
            showSuccess('Data imported successfully! Duplicates avoided.');
          } catch (err) {
            showError('Invalid file or format');
          }
          e.target.value = '';
        };
        reader.readAsBinaryString(file);
      }

      loadData() {
        try {
          const stored = localStorage.getItem('expenseDataEnhanced');
          if (stored) {
            const data = JSON.parse(stored);
            this.expenses = data.expenses || [];
            this.currencies = data.currencies || this.currencies;
            this.selectedCurrency = data.selectedCurrency || this.selectedCurrency;
          }
        } catch (e) {
          console.error('Failed to load data:', e);
        }
      }

      saveData() {
        try {
          localStorage.setItem('expenseDataEnhanced', JSON.stringify({
            expenses: this.expenses,
            currencies: this.currencies,
            selectedCurrency: this.selectedCurrency
          }));
          showSuccess('Data saved successfully!');
        } catch (e) {
          console.error('Failed to save data:', e);
        }
      }

      renderCurrencyOptions() {
        const select = document.getElementById('currencySelect');
        select.innerHTML = '';
        this.currencies.forEach(code => {
          const opt = el('option', { value: code, text: code, selected: code === this.selectedCurrency });
          select.appendChild(opt);
        });
      }
    }

    const expenseManager = new ExpenseManager();
  </script>
</body>
</html>